/*
BRONZE LAYER (Raw / Traceability)
- Purpose: Storing the EMS source file rows in their original form for auditability and replay.
- Data Handling:
  - All source fields are kept as NVARCHAR to preserve raw values exactly as received (no type casting here).
  - No business rules or validations are applied in Bronze.
- Lineage / Audit Columns:
  - RunId: ties each row back to a specific SSIS execution (etl.run_audit.RunId).
  - FileName: identifies the physical source file loaded in that run.
  - LoadUtc: when the row landed in Bronze.
  - SourceRowNum: row number from the source file (helps troubleshooting & trace-back).
- Usage:
  - Silver reads from Bronze to perform type conversions, standardization, validations, and rejects.
  - Bronze is append-only (history of loads). Duplicate source rows can exist across runs by design.
*/

----------------------------------------------------------------------------------------------------------------


CREATE TABLE ems.bronze.ems_raw (
    BronzeId     BIGINT IDENTITY(1,1) NOT NULL PRIMARY KEY,
    RunId        NVARCHAR(36) NOT NULL,              -- string GUID
    FileName     NVARCHAR(255) NOT NULL,
    LoadUtc      DATETIME2(3) NOT NULL DEFAULT SYSUTCDATETIME(),
    SourceRowNum BIGINT NOT NULL,

    -- raw columns (stored as NVARCHAR to preserve source values)
    INCIDENT_DT NVARCHAR(50) NULL,
    INCIDENT_COUNTY NVARCHAR(200) NULL,
    CHIEF_COMPLAINT_DISPATCH NVARCHAR(400) NULL,
    CHIEF_COMPLAINT_ANATOMIC_LOC NVARCHAR(400) NULL,
    PRIMARY_SYMPTOM NVARCHAR(400) NULL,
    PROVIDER_IMPRESSION_PRIMARY NVARCHAR(400) NULL,
    DISPOSITION_ED NVARCHAR(200) NULL,
    DISPOSITION_HOSPITAL NVARCHAR(200) NULL,
    INJURY_FLG NVARCHAR(50) NULL,
    NALOXONE_GIVEN_FLG NVARCHAR(50) NULL,
    MEDICATION_GIVEN_OTHER_FLG NVARCHAR(50) NULL,
    DESTINATION_TYPE NVARCHAR(200) NULL,
    PROVIDER_TYPE_STRUCTURE NVARCHAR(200) NULL,
    PROVIDER_TYPE_SERVICE NVARCHAR(200) NULL,
    PROVIDER_TYPE_SERVICE_LEVEL NVARCHAR(4000) NULL,
    PROVIDER_TO_SCENE_MINS NVARCHAR(4000) NULL,
    PROVIDER_TO_DESTINATION_MINS NVARCHAR(4000) NULL,
    UNIT_NOTIFIED_BY_DISPATCH_DT NVARCHAR(4000) NULL,
    UNIT_ARRIVED_ON_SCENE_DT NVARCHAR(4000) NULL,
    UNIT_ARRIVED_TO_PATIENT_DT NVARCHAR(4000) NULL,
    UNIT_LEFT_SCENE_DT NVARCHAR(4000) NULL,
    PATIENT_ARRIVED_DESTINATION_DT NVARCHAR(4000) NULL
);
GO

CREATE INDEX IX_ems_raw_RunId ON ems.bronze.ems_raw(RunId);
GO
